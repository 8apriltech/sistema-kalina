<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Medicamentos</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #020617;
            color: #f8fafc;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #e5e7eb;
        }

        .meses {
            text-align: center;
            margin-bottom: 20px;
        }

        .meses button {
            margin: 3px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #1e293b;
            color: #f8fafc;
        }

        .meses button.ativo {
    background: #38bdf8;
    color: #020617;
    font-weight: bold;
    box-shadow: 0 0 0 2px #0ea5e9 inset;
}


        .meses button:hover {
            background: #334155;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #020617;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        th {
            padding: 12px;
            border-bottom: 2px solid #334155;
            color: #cbd5f5;
            text-align: left;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #1e293b;
            color: #f8fafc;
        }

        /* Status */
        .verde { color: #22c55e; font-weight: bold; }
        .vermelho { color: #ef4444; font-weight: bold; }
        .azul { color: #38bdf8; font-weight: bold; }
        .cinza { color: #94a3b8; font-weight: bold; }

        /* Botões */
        button.marcar {
            padding: 6px 12px;
            background: #22c55e;
            color: #020617;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        button.marcar:hover {
            background: #16a34a;
        }

        input[type="date"] {
            padding: 6px;
            border-radius: 6px;
            border: none;
            margin-right: 6px;
        }
    </style>
</head>
<body>

<div style="margin-bottom:20px;">
    <button onclick="location.href='/'"
        style="
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #1e293b;
            color: #f8fafc;
            cursor: pointer;
        ">
        ⬅ Home
    </button>
</div>

<h1>Controle de Entrega de Medicamentos</h1>

<div id="contador-atrasados"
     style="
        text-align:center;
        margin-bottom:15px;
        font-size:18px;
        font-weight:bold;
        color:#ef4444;
        display:none;
     ">
</div>


<div class="meses">
    <button onclick="carregar(1)">Jan</button>
    <button onclick="carregar(2)">Fev</button>
    <button onclick="carregar(3)">Mar</button>
    <button onclick="carregar(4)">Abr</button>
    <button onclick="carregar(5)">Mai</button>
    <button onclick="carregar(6)">Jun</button>
    <button onclick="carregar(7)">Jul</button>
    <button onclick="carregar(8)">Ago</button>
    <button onclick="carregar(9)">Set</button>
    <button onclick="carregar(10)">Out</button>
    <button onclick="carregar(11)">Nov</button>
    <button onclick="carregar(12)">Dez</button>
</div>

<table>
    <thead>
        <tr>
            <th>Paciente</th>
            <th>Data de Retirada</th>
            <th>Status</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody id="tabela"></tbody>
</table>

<script>
const anoAtual = new Date().getFullYear();
let mesAtual = new Date().getMonth() + 1;


function carregar(mes) {
    mesAtual = mes;

     // remove destaque de todos os meses
    document.querySelectorAll(".meses button")
        .forEach(btn => btn.classList.remove("ativo"));

    // adiciona destaque no mês selecionado
    document.querySelector(`.meses button:nth-child(${mes})`)
        .classList.add("ativo");

    fetch(`/dashboard/?ano=${anoAtual}&mes=${mes}`)
        .then(res => res.json())
        .then(data => {
            const contador = document.getElementById("contador-atrasados");

        if (data.total_atrasados > 0) {
            contador.innerText = `⚠️ ${data.total_atrasados} paciente(s) atrasado(s) neste mês`;
            contador.style.display = "block";
        } else {
             contador.style.display = "none";
}

            const tbody = document.getElementById("tabela");
            tbody.innerHTML = "";

            data.dados.forEach(item => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${item.nome}</td>

                    <td>
                        ${
                            item.status === "Sem Registro"
                            ? `
                                <input type="date" id="data-${item.paciente_id}">
                                <button class="marcar"
                                    onclick="salvarData(${item.paciente_id}, ${mes})">
                                    Salvar
                                </button>
                              `
                            : item.data_prevista ?? "-"
                        }
                    </td>

                    <td class="${item.cor}">${item.status}</td>

                    <td>
    ${
        item.status !== "OK" && item.status !== "Sem Registro"
        ? `<button class="marcar"
            onclick="marcar(${item.retirada_id}, ${mes})">
            OK
          </button>`
        : ""
    }

   <button class="marcar"
    style="background:#ef4444; color:#ffffff; margin-left:6px;"
    onclick="excluirPaciente(${item.paciente_id})">
    Excluir
</button>

</td>

                `;

                tbody.appendChild(tr);
            });
        });
}

function salvarData(pacienteId, mes) {
    const input = document.getElementById(`data-${pacienteId}`);
    if (!input || !input.value) {
        alert("Informe a data de retirada");
        return;
    }

    fetch(`/retiradas/definir-data?paciente_id=${pacienteId}&ano=${anoAtual}&mes=${mes}&data_prevista=${input.value}`, {
        method: "POST"
    })
    .then(() => carregar(mesAtual));
}

function marcar(retiradaId, mes) {
    if (!retiradaId) return;

    fetch(`/retiradas/${retiradaId}/marcar`, { method: "PUT" })
        .then(() => carregar(mesAtual));
}

// carrega mês atual automaticamente
carregar(new Date().getMonth() + 1);

function excluirPaciente(pacienteId) {
    if (!confirm("Tem certeza que deseja excluir este paciente?")) return;

    fetch(`/pacientes/${pacienteId}`, {
        method: "DELETE"
    })
    .then(() => carregar(mesAtual));
}



</script>

</body>
</html>